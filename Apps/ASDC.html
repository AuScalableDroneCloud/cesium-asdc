<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Use correct character set. -->
  <meta charset="utf-8" />
  <!-- Tell IE to use the latest, best version. -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
  <title>ASDC Cesium Platform</title>
  <script type="text/javascript" src="/cesium/Apps/Sandcastle/Sandcastle-header.js"></script>
  <script src="/cesium/Build/Cesium/Cesium.js"></script>
  <!-- <script type="text/javascript" src="./Sandcastle/Sandcastle-header.js"></script>
  <script src="../Cesium/Cesium.js"></script> -->
  <!-- <script src="../Build/CesiumUnminified/Cesium.js"></script> -->
  <style>
    @import url(/cesium/Apps/Sandcastle/templates/bucket.css);

    /* @import url(../Build/Cesium/Widgets/widgets.css); */
    html,
    body,
    #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
  </style>
</head>

<body>
  <div id="cesiumContainer" class="fullSize"></div>
  <div id="toolbar"></div>
  <!-- <iframe  
    src="https://grafana.anu.appf.org.au/d/3eeo7zHmk/aggregator?orgId=1&from=1627012980283&to=1633002312780&var-address=All&var-sensor_v=air_relative_humidity&var-sensor_v=air_temperature&var-sensor_v=volumetric_water_content&var-alias=All&viewPanel=13"
    width="650"
    height="300"
    frameborder="0">
  </iframe > -->
  <script>
    Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1NWZkNGFlZS1iNzVhLTRmNTAtOThmYi1kMTI1MjlmOTVlNjciLCJpZCI6NzIyNTQsImlhdCI6MTYzNTkwNDI4OX0.EXVvJZa8yaugMmQNkc9pjWfrjqeOpZ8Jg7_0Hdwnb1A";

    var selectedDataset = "nue";

    var currentUrl = window.location.href;
    if (currentUrl[currentUrl.length - 1] === "/") currentUrl = currentUrl[currentUrl.length - 1];
    pathEnd = currentUrl.split('/')[currentUrl.split('/').length - 1];
    if (pathEnd != "asdc" && pathEnd != "asdc.html") {
      selectedDataset = pathEnd.toLowerCase();
    }

    const loadGeoJson = (dataset) => {

      var geoJsonPromise = Cesium.GeoJsonDataSource.load(dataset, {
        // clampToGround: true  //issues with picking polygons, using terrain sampling
      });

      // viewer.dataSources.add(geoJsonPromise);

      geoJsonPromise.then((dataSource) => {
        var entities = dataSource.entities.values;
        var samplePromises = [];

        dataSource.entities.values.map((entity) => {
          // dataSource.entities.values.slice(0,24).map((entity) => {
          var positions = entity.polygon.hierarchy.getValue().positions;
          var cartoPositions = [];
          positions.map(pos => {
            var carto = Cesium.Cartographic.fromCartesian(pos);
            cartoPositions.push(new Cesium.Cartographic(carto.longitude, carto.latitude));
          })

          samplePromises.push(Cesium.sampleTerrainMostDetailed(viewer.terrainProvider, cartoPositions).then((updatedPositions) => {
            var polygonEntity = viewer.entities.add({
              polygon:
              {
                hierarchy: new Cesium.PolygonHierarchy(Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(updatedPositions)),
                // hierarchy:new Cesium.CallbackProperty( () => {
                //   updatedPositions.map(cartoPoint=>{
                //   // var height = viewer.scene.sampleHeight(cartoPoint);
                //   var height = viewer.scene.globe.getHeight(cartoPoint);
                //   // console.log(height);
                //   if (height){
                //     cartoPoint.height=height;
                //   }
                // })
                //   return(new Cesium.PolygonHierarchy(Cesium.Ellipsoid.WGS84.cartographicArrayToCartesianArray(updatedPositions)));
                // },false),  //slow
                material: Cesium.Color.RED,
                perPositionHeight: true,
                // perPositionHeight: false, //picking issues
                arcType: Cesium.ArcType.GEODESIC
              }
            });
            polygonEntity.properties = entity.properties;
          }));
        })
        Promise.all(samplePromises).then(() => {
          delete (dataSource);
        })
      })

    }

    var highlightHeightPX = 27.2;
    var highlightColor = 'green';

    const loadDataset = (dataset) => {
      if (dataset === "nue") {
        selectedDataset = "nue";

        if (!tilesets["nue"]) {
          tilesets["nue"] = {};
          tilesets["nue"][new Date("2017-07-21")] = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
            url: 'https://appf-anu.s3.ap-southeast-2.amazonaws.com/Cesium/NUE_20170721_M1_RGB_group1_densified_point_cloud/tileset.json',
            show: false
          }));


          tilesets["nue"][new Date("2017-09-22")] = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
            url: 'https://appf-anu.s3.ap-southeast-2.amazonaws.com/Cesium/NUE_20170922_M2_RGB_group1_densified_point_cloud/tileset.json',
            show: false
          }));

          tilesets["nue"][new Date("2017-10-16")] = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
            url: 'https://appf-anu.s3.ap-southeast-2.amazonaws.com/Cesium/NUE_20171016_M4_RGB_group1_densified_point_cloud/tileset.json',
            show: false
          }));

          viewer.timeline.addHighlightRange(highlightColor, highlightHeightPX).setRange(Cesium.JulianDate.fromIso8601("2017-07-21"), Cesium.JulianDate.fromIso8601("2017-07-22"));
          viewer.timeline.addHighlightRange(highlightColor, highlightHeightPX).setRange(Cesium.JulianDate.fromIso8601("2017-09-22"), Cesium.JulianDate.fromIso8601("2017-09-23"));
          viewer.timeline.addHighlightRange(highlightColor, highlightHeightPX).setRange(Cesium.JulianDate.fromIso8601("2017-10-16"), Cesium.JulianDate.fromIso8601("2017-10-17"));

        }

        viewer.timeline.zoomTo(Cesium.JulianDate.fromIso8601("2017-07-21"), Cesium.JulianDate.fromIso8601("2017-10-17"));

        viewer.clock.currentTime = new Cesium.JulianDate.fromIso8601("2017-07-21");

        viewer.flyTo(tilesets["nue"][Object.keys(tilesets["nue"])[0]]);


      }
      else if (dataset === "usln") {
        selectedDataset = "usln";

        if (!tilesets["usln"]) {
          tilesets["usln"] = {};
          tilesets["usln"][new Date("2021-05-21")] = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
            url: 'https://appf-anu.s3.ap-southeast-2.amazonaws.com/Cesium/USLN-GegedzerickRoad_2021-05-21-odm_georeferenced_model/tileset.json',
            show: false
          }));

          //clamp model centre to terrain
          tilesets["usln"][new Date("2021-05-21")].readyPromise.then(function (tileset) {
            var positions = [
              Cesium.Cartographic.fromCartesian(tileset.boundingSphere.center)
            ];
            var promise = Cesium.sampleTerrainMostDetailed(viewer.terrainProvider, positions);
            Cesium.when(promise, function (updatedPositions) {
              updatedPositions[0].height += 10;
              var offset = Cesium.Cartographic.toCartesian(updatedPositions[0]);
              var translation = Cesium.Cartesian3.subtract(offset, tileset.boundingSphere.center, new Cesium.Cartesian3());
              tileset.modelMatrix = Cesium.Matrix4.fromTranslation(translation);
            });
          });

          viewer.timeline.addHighlightRange(highlightColor, highlightHeightPX).setRange(Cesium.JulianDate.fromIso8601("2021-05-21"), Cesium.JulianDate.fromIso8601("2021-05-22"));
        }
        viewer.timeline.zoomTo(Cesium.JulianDate.fromIso8601("2021-05-21"), Cesium.JulianDate.fromIso8601("2021-05-22"));
        viewer.clock.currentTime = new Cesium.JulianDate.fromIso8601("2021-05-21");

        viewer.flyTo(tilesets["usln"][new Date("2021-05-21")]);

      }
      else if (dataset === "vbir") {

        selectedDataset = "vbir";

        if (!tilesets["vbir"]) {
          tilesets["vbir"] = {};
          tilesets["vbir"][new Date("2019-07-02")] = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
            url: 'https://appf-anu.s3.ap-southeast-2.amazonaws.com/Cesium/WheatHub_DPP_VBIR/20190702_VBIR_1_DenseCloud/tileset.json',
            show: false
          }));

          tilesets["vbir"][new Date("2019-08-01")] = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
            url: 'https://appf-anu.s3.ap-southeast-2.amazonaws.com/Cesium/WheatHub_DPP_VBIR/20190801_VBIR_2_DenseCloud/tileset.json',
            show: false
          }));

          tilesets["vbir"][new Date("2019-08-30")] = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
            url: 'https://appf-anu.s3.ap-southeast-2.amazonaws.com/Cesium/WheatHub_DPP_VBIR/20190830_VBIR_3_DenseCloud/tileset.json',
            show: false
          }));

          tilesets["vbir"][new Date("2019-10-01")] = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
            url: 'https://appf-anu.s3.ap-southeast-2.amazonaws.com/Cesium/WheatHub_DPP_VBIR/20191001_VBIR_4_DenseCloud/tileset.json',
            show: false
          }));

          tilesets["vbir"][new Date("2019-10-15")] = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
            url: 'https://appf-anu.s3.ap-southeast-2.amazonaws.com/Cesium/WheatHub_DPP_VBIR/20191015_VBIR_5_DenseCloud/tileset.json',
            show: false
          }));

          viewer.timeline.addHighlightRange(highlightColor, highlightHeightPX).setRange(Cesium.JulianDate.fromIso8601("2019-07-02"), Cesium.JulianDate.fromIso8601("2019-07-03"));
          viewer.timeline.addHighlightRange(highlightColor, highlightHeightPX).setRange(Cesium.JulianDate.fromIso8601("2019-08-01"), Cesium.JulianDate.fromIso8601("2019-08-02"));
          viewer.timeline.addHighlightRange(highlightColor, highlightHeightPX).setRange(Cesium.JulianDate.fromIso8601("2019-08-30"), Cesium.JulianDate.fromIso8601("2019-08-31"));
          viewer.timeline.addHighlightRange(highlightColor, highlightHeightPX).setRange(Cesium.JulianDate.fromIso8601("2019-10-01"), Cesium.JulianDate.fromIso8601("2019-10-02"));
          viewer.timeline.addHighlightRange(highlightColor, highlightHeightPX).setRange(Cesium.JulianDate.fromIso8601("2019-10-15"), Cesium.JulianDate.fromIso8601("2019-10-16"));


          loadGeoJson('https://appf-anu.s3.ap-southeast-2.amazonaws.com/Cesium/WheatHub_DPP_VBIR/VBIR_EM3.geojson');
          loadGeoJson('https://appf-anu.s3.ap-southeast-2.amazonaws.com/Cesium/WheatHub_DPP_VBIR/VBIR_S2M3.geojson');
        }
        viewer.timeline.zoomTo(Cesium.JulianDate.fromIso8601("2019-07-02"), Cesium.JulianDate.fromIso8601("2019-10-16"));
        viewer.clock.currentTime = new Cesium.JulianDate.fromIso8601("2019-07-02");

        viewer.flyTo(tilesets["vbir"][Object.keys(tilesets["vbir"])[0]]);
      }
      else if (dataset === "dryandra_model") {

        var promise = Cesium.sampleTerrainMostDetailed(viewer.terrainProvider, [new Cesium.Cartographic.fromDegrees(149.1106974606, -35.2614095095)]);
        Cesium.when(promise, function (updatedPositions) {
          var url = 'https://appf-anu.s3.ap-southeast-2.amazonaws.com/Cesium/Dryandra+Tree/dryandra-tree-scan.glb';
          // var position = Cesium.Cartesian3.fromDegrees(
          //   149.1106873966594,
          //   -35.261415607183686,
          //   updatedPositions[0].height + 3.9608609676361084 //sampled height + half model height
          // );
          // manual
          var position = Cesium.Cartesian3.fromDegrees(
            149.1106974606,
            -35.2614095095,
            updatedPositions[0].height + 3
          );

          var hpr = new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(110), Cesium.Math.toRadians(0), Cesium.Math.toRadians(-2));
          var orientation = Cesium.Transforms.headingPitchRollQuaternion(
            position,
            hpr
          );

          entities["dryandra"] = viewer.entities.add({
            position: position,
            orientation: orientation,
            model: {
              uri: url,
            }
          });

          viewer.flyTo(entities["dryandra"]);
        });
      }
      else if (dataset === "dryandra_pointcloud") {

        if (!tilesets["dryandra"]) {
          tilesets["dryandra"] = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
            url: 'https://appf-anu.s3.ap-southeast-2.amazonaws.com/Cesium/Dryandra+Tree/Point+Cloud/tileset.json',
          }));

          tilesets["dryandra"].modelMatrix

        } else {
          tilesets["dryandra"].show = checked;
        }
        viewer.flyTo(tilesets["dryandra"]);

      }
      else if (dataset === "graffiti_model") {
        var promise = Cesium.sampleTerrainMostDetailed(viewer.terrainProvider, [new Cesium.Cartographic.fromDegrees(149.1109390899, -35.2654136809)]);
        Cesium.when(promise, function (updatedPositions) {
          var url = 'https://appf-anu.s3.ap-southeast-2.amazonaws.com/Cesium/Graffiti+Underpass/scene.gltf'
          // var position = Cesium.Cartesian3.fromDegrees(
          //   149.11093029457186,
          //   -35.26540200316355, 
          //   updatedPositions[0].height
          // );
          //manual
          var position = Cesium.Cartesian3.fromDegrees(
            149.1109390899,
            -35.2654136809,
            updatedPositions[0].height + 4.5
          );
          var hpr = new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(-15), Cesium.Math.toRadians(1), Cesium.Math.toRadians(5));
          var orientation = Cesium.Transforms.headingPitchRollQuaternion(
            position,
            hpr
          );

          entities["graffiti"] = viewer.entities.add({
            position: position,
            orientation: orientation,
            model: {
              uri: url,
            },
          });

          viewer.flyTo(entities["graffiti"]);

        });
      }
      else if (dataset === "graffiti_pointcloud") {
        if(!tilesets["graffiti"]){
          tilesets["graffiti"] = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
            url: 'https://appf-anu.s3.ap-southeast-2.amazonaws.com/Cesium/Graffiti+Underpass/Point+Cloud/tileset.json',
          }));
        }
        viewer.flyTo(tilesets["graffiti"]);
      }
    }

    var viewer = new Cesium.Viewer('cesiumContainer', {
      terrainProvider: Cesium.createWorldTerrain(),
      // selectionIndicator: false
    });
    viewer.scene.screenSpaceCameraController.enableCollisionDetection = false;
    // viewer.scene.globe.depthTestAgainstTerrain = true;


    Sandcastle.addToolbarMenu([
      {
        text: "WheatHub - NUE",
        onselect: function () {
          window.history.pushState('', '', '/cesium/apps/asdc/nue');
          loadDataset("nue");
        },
      },
      {
        text: "WheatHub - VBIR",
        onselect: function () {
          window.history.pushState('', '', '/cesium/apps/asdc/vbir');
          loadDataset("vbir");
        },
      }
    ])
    document.getElementById("toolbar").childNodes[0].selectedIndex = selectedDataset === 'vbir' ? 1 : 0;

    Sandcastle.addToolbarButton("USLN", function () {
      window.history.pushState('', '', '/cesium/apps/asdc/usln');
      loadDataset("usln");
    });

    Sandcastle.addToggleButton("Dryandra Tree Model", selectedDataset === "dryandra_model", function (checked) {
      selectedDataset = "dryandra_model";
      window.history.pushState('', '', '/cesium/apps/asdc/dryandra_model');

      if (!entities["dryandra"]) {
        loadDataset("dryandra_model");
      } else {
        entities["dryandra"].show = checked;
        if (checked) viewer.flyTo(entities["dryandra"]);
      }
    });

    Sandcastle.addToggleButton("Dryandra Tree Point Cloud", selectedDataset === "dryandra_pointcloud", function (checked) {
      selectedDataset = "dryandra_pointcloud";
      window.history.pushState('', '', '/cesium/apps/asdc/dryandra_pointcloud');

      if (!tilesets["dryandra"]) {
        loadDataset("dryandra_pointcloud");
      } else {
        tilesets["dryandra"].show = checked;
        if (checked) viewer.flyTo(tilesets["dryandra"]);
      }
    });

    Sandcastle.addToggleButton("Graffiti Model", selectedDataset === "graffiti_model", function (checked) {
      selectedDataset = "graffiti_model";
      window.history.pushState('', '', '/cesium/apps/asdc/graffiti_model');
      if (!entities["graffiti"]) {
        loadDataset("graffiti_model");
      } else {
        entities["graffiti"].show = checked;
        if (checked) viewer.flyTo(entities["graffiti"]);
      }
    });

    Sandcastle.addToggleButton("Graffiti Point Cloud", selectedDataset === "graffiti_pointcloud", function (checked) {
      selectedDataset = "graffiti_pointcloud";
      window.history.pushState('', '', '/cesium/apps/asdc/graffiti_pointcloud');
      if (!tilesets["graffiti"]) {
        loadDataset("graffiti_pointcloud");
      } else {
        tilesets["graffiti"].show = checked;
        if (checked) viewer.flyTo(tilesets["graffiti"]);
      }
    });

    var tilesets = {};
    var entities = {};

    loadDataset(selectedDataset);

    viewer.clock.onTick.addEventListener((clock) => {
      currentTime = Cesium.JulianDate.toDate(clock.currentTime).getTime();
      if (tilesets[selectedDataset]) {
        var tilesetDates = Object.keys(tilesets[selectedDataset]);
        for (var i = 0; i < tilesetDates.length; i++) {
          if ((i === 0 || new Date(tilesetDates[i]).getTime() <= currentTime) && (i === tilesetDates.length - 1 || new Date(tilesetDates[i + 1]).getTime() >= currentTime)) {
            tilesets[selectedDataset][tilesetDates[i]].show = true;
          } else {
            tilesets[selectedDataset][tilesetDates[i]].show = false;
          }
        }
      }
    });

    var selectedEntity = new Cesium.Entity();
    var clickHandler = viewer.screenSpaceEventHandler.getInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);
    viewer.screenSpaceEventHandler.setInputAction(function onLeftClick(movement) {
      var pickedFeature = viewer.scene.drillPick(movement.position).filter(feature => {

        if (!(feature.primitive instanceof Cesium.Cesium3DTileset))
          return feature
      })[0];

      if (!Cesium.defined(pickedFeature)) {
        clickHandler(movement);
        return;
      }

      selectedEntity = pickedFeature.id;

      selectedEntity.description = '<table class="cesium-infoBox-defaultTable"><tbody>';
      for (var i = 0; i < selectedEntity.properties._propertyNames.length; i++) {
        selectedEntity.description += '<tr><th>' + selectedEntity.properties._propertyNames[i] + '</th><td>' + selectedEntity.properties[selectedEntity.properties._propertyNames[i]].getValue() + '</td></tr>';
      }
      selectedEntity.description += '</tbody></table>';
      viewer.selectedEntity = selectedEntity;

    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

  </script>
</body>

</html>